
{% extends "base.html" %}

{% block title %}Ready for Delivery (Undelivered){% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Devices Ready for Delivery</h1>
    <div class="alert alert-info text-center">
        These devices are serviced but <strong>Undelivered</strong>. Update payment and check "Delivered" to archive them.
    </div>

    <div class="d-none d-md-block">
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Device</th>
                    <th>Serial No</th>
                    <th>Customer</th>
                    <th>Phone</th>
                    <th>Bill Value</th>
                    <th>Bill Status</th>
                    <th>Amt Received</th>
                    <th>Mark Delivered</th>
                    <th colspan="3" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for device in closed_devices %}
                <tr id="device-{{ device.id }}">
                    <td>{{ device.device_name }}</td>
                    <td>{{ device.serial_number }}</td>
                    <td>{{ device_customer_info[device.id].name }}</td>
                    <td>{{ device_customer_info[device.id].whatsapp_number }}</td>
                    <td>â‚¹{{ device.bill_value }}</td>
                    <td>
                        <select class="form-control bill-status">
                            <option value="unpaid" {% if device.bill_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
                            <option value="paid" {% if device.bill_status == 'paid' %}selected{% endif %}>Paid</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control amount-received" placeholder="â‚¹" value="{{ device.amount_received or '' }}">
                    </td>
                    <td class="text-center align-middle">
                        <input class="form-check-input" type="checkbox" id="deliveryStatus-{{ device.id }}" style="transform: scale(1.5);">
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" title="Save/Close" onclick="closeDevice('{{ device.id }}')">âœ… Save</button>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" title="Print Bill" onclick="printDevice('{{ device.id }}')">ðŸ§¾</button>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" title="WhatsApp" onclick="sendToWhatsApp('{{ device_customer_info[device.id].whatsapp_number }}', '{{ device.id }}')">ðŸ“±</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="d-block d-md-none">
        {% for device in closed_devices %}
        <div class="card mb-3 shadow-sm" id="device-mobile-{{ device.id }}">
            <div class="card-body">
                <h5 class="card-title">{{ device.device_name }} <span class="badge badge-warning float-right">Ready</span></h5>
                <p class="mb-1"><strong>Serial:</strong> {{ device.serial_number }}</p>
                <p class="mb-1"><strong>Customer:</strong> {{ device_customer_info[device.id].name }}</p>
                <p class="mb-1"><strong>Phone:</strong> {{ device_customer_info[device.id].whatsapp_number }}</p>
                <p class="mb-1"><strong>Bill Value:</strong> â‚¹{{ device.bill_value }}</p>

                <hr>

                <div class="form-group">
                    <label>Bill Status:</label>
                    <select class="form-control bill-status">
                        <option value="unpaid" {% if device.bill_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
                        <option value="paid" {% if device.bill_status == 'paid' %}selected{% endif %}>Paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Received:</label>
                    <input type="number" class="form-control amount-received" placeholder="â‚¹ Received" value="{{ device.amount_received or '' }}">
                </div>
                <div class="form-group form-check p-3 bg-light rounded border">
                    <input class="form-check-input" type="checkbox" id="deliveryStatus-mobile-{{ device.id }}" style="transform: scale(1.3); margin-left: 0;">
                    <label class="form-check-label font-weight-bold ml-4" for="deliveryStatus-mobile-{{ device.id }}">Mark as Delivered</label>
                </div>

                <div class="btn-group d-flex" role="group">
                    <button class="btn btn-success w-100" onclick="closeDevice('{{ device.id }}', true)">âœ… Save</button>
                    <button class="btn btn-primary w-100" onclick="printDevice('{{ device.id }}')">ðŸ§¾ Bill</button>
                    <button class="btn btn-success w-100" onclick="sendToWhatsApp('{{ device_customer_info[device.id].whatsapp_number }}', '{{ device.id }}')">ðŸ“± App</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not closed_devices %}
    <div class="text-center mt-5">
        <h4 class="text-muted">No devices waiting for delivery.</h4>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Go to Dashboard</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function closeDevice(deviceId, isMobile=false) {
    // Select elements based on view (Mobile vs Desktop)
    let container;
    if (isMobile) {
        container = document.querySelector(`#device-mobile-${deviceId}`);
    } else {
        container = document.querySelector(`#device-${deviceId}`);
    }

    const billStatus = container.querySelector(".bill-status").value;
    const amountReceived = container.querySelector(".amount-received").value;

    // Checkbox ID differs for mobile vs desktop to allow unique IDs
    const checkboxId = isMobile ? `#deliveryStatus-mobile-${deviceId}` : `#deliveryStatus-${deviceId}`;
    const deliveryStatus = container.querySelector(checkboxId).checked;

    const csrfToken = "{{ csrf_token() }}"; // Use Flask-WTF to generate token

    fetch("/close_device_all", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken
        },
        body: new URLSearchParams({
            device_id: deviceId,
            bill_status: billStatus,
            amount_received: amountReceived,
            delivery_status: deliveryStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // If Delivered, remove the row/card
            if (deliveryStatus) {
                alert("Device Delivered and Archived!");
                container.remove();

                // If no rows left, reload to show empty state
                if (document.querySelectorAll('tbody tr').length === 0) {
                     location.reload();
                }
            } else {
                alert("Payment Info Updated (Still Undelivered)");
            }
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong.");
    });
}

function printDevice(deviceId) {
    // Opens the existing print_bill route
    window.open(`/print_bill/${deviceId}`, '_blank');
}

function sendToWhatsApp(phone, deviceId) {
    // Simple WhatsApp link generator
    const message = `Hello, regarding your device (ID: ${deviceId}). It is ready for collection.`;
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
