{% extends "base.html" %}

{% block title %}Devices Ready for Delivery{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Devices Ready for Delivery (Serviced)</h2>

    {% if not delivery_devices %}
    <div class="alert alert-success text-center">
        No pending serviced devices. Good job!
    </div>
    {% endif %}

    {% for device in delivery_devices %}
    <div class="card mb-3 shadow-sm border-primary">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <h5 class="card-title text-primary">{{ device.device_name }}</h5>
                <span class="badge badge-warning">Status: {{ device.assign_status.value }}</span>
            </div>

            <p class="mb-1"><strong>Serial Number:</strong> {{ device.serial_number }}</p>
            <p class="mb-1"><strong>Issue:</strong> {{ device.issue_description }}</p>

            <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="toggleServiceDetails('{{ device.id }}')">
                Show Billing & Delivery Options
            </button>

            <div class="mt-3 p-3 bg-light rounded" id="service-details-{{ device.id }}" style="display: none;">

                <h6>Parts Used:</h6>
                <ul class="list-group mb-3">
                    {% for service in device_service_info[device.id] %}
                    <li class="list-group-item d-flex justify-content-between py-1">
                        <small>{{ service.spare_name }}</small>
                        <small>₹{{ service.cost }}</small>
                    </li>
                    {% endfor %}
                    {% if not device_service_info[device.id] %}
                    <li class="list-group-item text-muted py-1"><small>No spare parts added</small></li>
                    {% endif %}
                </ul>

                <label>Final Bill Amount:</label>
                <input type="number" class="form-control mb-2" id="bill-value-{{ device.id }}"
                       placeholder="Total Bill Value" required min="0">

                <label>Amount Received (Now):</label>
                <input type="number" class="form-control mb-3" id="amount-received-{{ device.id }}"
                       placeholder="₹ Amount Paid by Customer" value="0">

                <div class="row">
                    <div class="col-6">
                        <form action="{{ url_for('generate_bill') }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="device_id" value="{{ device.id }}">
                            <input type="hidden" name="bill_value" id="hidden-bill-{{ device.id }}">
                            <button type="submit" class="btn btn-secondary btn-block btn-sm"
                                    onclick="copyBillValue('{{ device.id }}')">
                                Generate Bill Only<br><small>(Pay Later)</small>
                            </button>
                        </form>
                    </div>

                    <div class="col-6">
                        <button class="btn btn-success btn-block btn-sm" onclick="deliverAndPrint('{{ device.id }}')">
                            Deliver & Print<br><small>(Close Ticket)</small>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function toggleServiceDetails(deviceId) {
        $('#service-details-' + deviceId).toggle();
    }

    // Helper to copy the value for the 'Generate Bill' form submission
    function copyBillValue(deviceId) {
        const val = document.getElementById('bill-value-' + deviceId).value;
        document.getElementById('hidden-bill-' + deviceId).value = val;
    }

    function deliverAndPrint(deviceId) {
    const billInput = document.getElementById('bill-value-' + deviceId).value;
    const receivedInput = document.getElementById('amount-received-' + deviceId).value;

    if (!billInput) {
        alert("Please enter a Final Bill Value.");
        return;
    }
     const csrfToken = document
        .querySelector('meta[name="csrf-token"]')
        .getAttribute('content');
    $.ajax({
        url: '/close_device',
        type: 'POST',
        dataType: 'json',
        data: {
            device_id: deviceId,
            bill_value: billInput,
            amount_received: receivedInput,
            csrf_token: "{{ csrf_token() }}"
        },
        success: function(resp) {
            if (resp.success) {
                window.open('/print_bill/' + deviceId, '_blank');
                alert('Device Delivered Successfully!');
                window.location.reload();
            } else {
                alert(resp.error || 'Failed to close device');
            }
        },
        error: function(xhr) {
            alert('Error closing device');
        }
    });
}
</script>
{% endblock %}