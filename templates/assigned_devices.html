{# templates/assigned_devices.html #}
{% extends "base.html" %}
{% block title %}Assigned Devices{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Assigned Devices</h3>

    <div>
      <form id="userFilterForm" method="get" action="{{ url_for('assigned_devices') }}" class="d-flex align-items-center">
        <label for="userSelect" class="me-2 mb-0">Show devices for</label>
        <select name="user_id" id="userSelect" class="form-select" style="min-width:220px;">
          <option value="">-- All assigned devices --</option>
          {% for u in users %}
            {# users could be a list or map depending on route; handle both #}
            {% if u is mapping %}
              {% set uid = u.id %}
              {% set uname = u.username %}
            {% else %}
              {% set uid = u.id %}
              {% set uname = u.username %}
            {% endif %}
            <option value="{{ uid }}" {% if selected_user_id and uid == selected_user_id %}selected{% endif %}>{{ uname }}{% if u.user_level %} ({{ u.user_level }}){% endif %}</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  {% if not assigned_devices %}
    <div class="alert alert-info">No assigned devices found.</div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Device Name</th>
            <th>Customer Name</th>
            <th>Customer WhatsApp</th>
            <th>Issue / Description</th>
            <th>Assigned To</th>
            <th>Expected Budget</th>
            <th>Expected Delivery</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for d in assigned_devices %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ d.device_name or '-' }}</td>

            {% set cust = device_customer_info.get(d.customer_id) %}
            <td>{{ cust.name if cust else 'Unknown' }}</td>
            <td>{{ cust.whatsapp_number if cust and cust.whatsapp_number else '-' }}</td>

            <td style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              {{ d.issue_description or d.remark or '-' }}
            </td>

            <td>
              {% if d.assigned_to %}
                {% set assigned_user = (users | selectattr('id','equalto', d.assigned_to) | list).0 %}
                {% if assigned_user %}
                  {{ assigned_user.username }}
                {% else %}
                  {{ d.assigned_to }}
                {% endif %}
              {% else %}
                Unassigned
              {% endif %}
            </td>

            <td>{{ d.expected_budget or '-' }}</td>

            <td>
              {% if d.expected_delivery_date %}
                {# If it's datetime or date, render safely #}
                {% if d.expected_delivery_date.strftime is defined %}
                  {{ d.expected_delivery_date.strftime('%Y-%m-%d') }}
                {% else %}
                  {{ d.expected_delivery_date }}
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>

            <td>
              <a href="{{ url_for('service', device_id=d.id) }}" class="btn btn-sm btn-outline-primary">Service</a>
              <a href="{{ url_for('ack_ticket', device_id=d.id) }}" class="btn btn-sm btn-outline-secondary">Ack</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<script>
  // Submit the filter form when a user is selected
  document.addEventListener('DOMContentLoaded', function () {
    const sel = document.getElementById('userSelect');
    if (sel) {
      sel.addEventListener('change', function () {
        // submit the form (GET) to show devices for selected user
        document.getElementById('userFilterForm').submit();
      });
    }
  });
</script>
{% endblock %}
