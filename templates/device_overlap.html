{# templates/device_overlap.html #}
{% extends "base.html" %}
{% block title %}Overdue Devices{% endblock %}

{% block content %}
<div class="container">
  <h2>Overdue / Pending Devices</h2>

  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Service ID</th>
        <th>Device</th>
        <th>Customer</th>
        <th>Expected Delivery</th>
        <th>Assigned To</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for device in pending_devices %}
      <tr>

        <td>{{ device.service_id }}</td>

        <td>{{ device.device_name or '-' }}</td>

        <td>
          {% set cust = device_customer_info.get(device.customer_id) %}
          {{ cust.name if cust else 'Unknown' }}
        </td>

        <td>
          {% if device.expected_delivery_date %}
            {{ device.expected_delivery_date.strftime('%Y-%m-%d') }}
          {% else %}
            -
          {% endif %}
        </td>

        <td>
          {% if device.assigned_to %}
            {{ assigned_users_map.get(device.assigned_to).username
               if assigned_users_map.get(device.assigned_to)
               else 'Unknown' }}
          {% else %}
            Unassigned
          {% endif %}
        </td>

        <td>
          <button class="btn btn-sm btn-primary"
                  data-bs-toggle="collapse"
                  data-bs-target="#assignForm{{ device.id }}">
            Assign / Update
          </button>

          <div id="assignForm{{ device.id }}" class="collapse mt-2">
            <form method="post" action="{{ url_for('update_device_info') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="device_id" value="{{ device.id }}">

              <!-- Assign -->
              <div class="mb-2">
                <label class="form-label">Assign To</label>
                <select name="assigned_to" class="form-select">
                  <option value="">-- Select user --</option>
                  {% for u in available_users %}
                    <option value="{{ u.id }}"
                      {% if device.assigned_to == u.id %}selected{% endif %}>
                      {{ u.username }} ({{ u.user_level }})
                    </option>
                  {% endfor %}
                </select>
              </div>

              <!-- New Expected Date -->
              <div class="mb-2">
                <label class="form-label">New Expected Date</label>
                <input type="date"
                       name="new_expected_date"
                       class="form-control"
                       value="{{ device.expected_delivery_date.strftime('%Y-%m-%d')
                               if device.expected_delivery_date else '' }}">
              </div>

              <!-- Description -->
              <div class="mb-2">
                <label class="form-label">Issue / Remarks</label>
                <textarea name="description"
                          class="form-control"
                          rows="2">{{ device.issue_description or device.remark or '' }}</textarea>
              </div>

              <!-- ðŸ” AUDIT REASON (MANDATORY) -->
              <div class="mb-2">
                <label class="form-label text-danger">
                  Reason for Update <small>(required)</small>
                </label>
                <textarea name="update_reason"
                          class="form-control"
                          rows="2"
                          required
                          placeholder="Why is this device being updated?"></textarea>
              </div>

              <button type="submit" class="btn btn-success btn-sm">
                Save Changes
              </button>

            </form>
          </div>

        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
    Back to dashboard
  </a>
</div>
{% endblock %}